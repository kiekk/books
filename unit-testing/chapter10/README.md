## 10장. 데이터베이스 테스트

#### 10.1.3 모든 개발자를 위한 별도의 데이터베이스 인스턴스

```markdown
실제 데이터베이스로 테스트하는 것은 충분히 어렵다.
다른 개발자들과 데이터베이스를 공유해야 한다면 훨씬 더 어려워진다.
공유 데이터베이스를 사용하면 개발 프로세스를 방해하게 된다.
그 이유는 다음과 같다.
- 서로 다른 개발자가 실행한 테스트는 서로 간섭되기 때문이다.
- 하위 호환성이 없는 변경으로 다른 개발자의 작업을 막을 수 있기 때문이다.
테스트 실행 속도를 극대화하려면 개발자마다 (가능하면 개발자 머신에서) 별도로 데이터베이스 인스턴스를 사용하라.
```

### 10.3 테스트 데이터 생명 주기

```markdown
공유 데이터베이스를 사용하면 통합 테스트를 서로 분리할 수 없는 문제가 생긴다.
이 문제를 해결하려면,
- 통합 테스트를 순차적으로 실행하라.
- 테스트 실행 간에 남은 데이터를 제거하라.
전체적으로 테스트는 데이터베이스 상태에 따라 달라지면 안 된다.
테스트는 데이터베이스 상태를 원하는 조건으로 만들어야 한다.
```

#### 10.3.1 병렬 테스트 실행과 순차적 테스트 실행

```markdown
통합 테스트를 병렬로 실행하려면 상당한 노력이 필요하다.
...
성능 향상을 위해 시간을 허비하지 말고 순차적으로 통합 테스트를 실행하는 것이 더 실용적이다.
```

#### 10.3.2 테스트 실행 간 데이터 정리

```markdown
테스트 실행 간에 남은 데이터를 정리하는 방법은 네 가지가 있다.
- 각 테스트 전에 데이터베이스 백업 복원하기: 이 방법은 데이터 정리 문제를 해결할 수 있지만 다른 세 가지 방법보다 훨씬 느리다.
- 테스트 종료 시점에 데이터 정리하기: 이 방법은 빠르지만 정리 단계를 건너뛰기 쉽다.
  테스트 도중에 빌드 서버가 중단하거나 디버거에서 테스트를 종료하면 입력 데이터는 데이터베이스에 남아있고 이후 테스트 실행에 영향을 주게 된다.
- 데이터베이스 트랜잭션에 각 테스트를 래핑하고 커밋하지 않기: 이 경우 테스트와 SUT에서 변경한 모든 내용이 자동으로 롤백된다.
- 테스트 시작 시점에 데이터 정리하기: 이 방법이 가장 좋다. 빠르게 작동하고 일관성이 없는 동작을 일으키지 않으며, 정리 단계를 실수로 건너뛰지 않는다.
```

### 10.4 테스트 구절에서 코드 재사용하기

```markdown
통합 테스트가 너무 빨리 커지면 유지 보수 지표가 나빠질 수 있다.
통합 테스트는 가능한한 짧게 하되 서로 결합하거나 가독성에 영향을 주지 않는 것이 중요하다.
아무리 짧은 테스트일지라도 서로 의존해서는 안 된다.
또한 테스트 시나리오의 전체 컨텍스트를 유지해야 하며, 진행 상황을 이해하려고 테스트 클래스의 다른 부분을 검사해서는 안 된다.
통합 테스트를 짧게 하기에 가장 좋은 방법은 비즈니스와 관련이 없는 기술적인 부분을 비공개 메서드나 헬퍼 클래스로 추출하는 것이다.
더구나 그 부분은 재사용할 수 있다.
```

#### 10.5 데이터베이스 테스트에 대한 일반적인 질문

#### 10.5.1 읽기 테스트를 해야 하는가?

```markdown
대부분의 애플리케이션에는 쓰기와 읽기 작업이 모두 있다.
읽기 작업의 예는 사용자 정보를 외부 클라이언트로 반환하는 것이다.
쓰기와 읽기 모두 테스트해야 하는가?
쓰기를 철저히 테스트하는 것이 매우 중요하다.
왜냐하면 위험성이 매우 높기 때문이다.
쓰기 작업이 잘못되면 데이터가 손상돼 데이터베이스뿐만 아니라 외부 애플리케이션에도 영향을 미칠 수 있다.
쓰기를 다루는 테스트는 이러한 실수에 대비한 보호책이 되므로 매우 가치가 있다.
그러나 읽기는 이에 해당하지 않는다.
읽기 작업의 버그에는 보통 해로운 문제가 없다.
따라서 읽기 테스트 임계치는 쓰기 테스트 임계치보다 높아야 한다.
가장 복잡하거나 중요한 읽기 작업만 테스트하고, 나머지는 무시하라.
...
읽기를 테스트하기로 결정한 경우에는 실제 데이터베이스로 통합 테스트를 하라.
```

#### 10.5.2 리포지터리 테스트를 해야 하는가?

```markdown
리포지터리를 다른 통합 테스트와는 독립적으로 테스트해야 하는가?
리포지터리가 도메인 객체를 어떻게 데이터베이스에 매핑하는지를 테스트하는 것이 유익할지 모른다.
결국 이 기능에는 실수가 상당히 있을 여지가 있다.
그러나 이러한 테스트는 유지비가 높고 회귀 방지가 떨어져서 테스트 스위트에 손실이 된다.
...
리포지터리는 직접 테스트하지 말고, 포괄적인 통합 테스트 스위트의 일부로 취급하라.
```

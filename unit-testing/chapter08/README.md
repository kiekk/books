## 8장. 통합 테스트를 하는 이유

```markdown
단위 테스트에만 전적으로 의존하면 시스템이 전체적으로 잘 작동하는지 확신할 수 없다.
단위 테스트가 비즈니스 로직을 확인하는 데 좋지만, 비즈니스 로직을 외부와 단절된 상태로 확인하는 것만으로는 충분하지 않다.
각 부분이 데이터베이스나 메시지 버스 등의 외부 시스템과 어떻게 통합되는지 확인해야 한다.
```

### 8.1 통합 테스트는 무엇인가?

```markdown
통합 테스트는 테스트 스위트에서 중요한 역할을 하며, 단위 테스트 개수와 통합 테스트 개수의 균형을 맞추는 것도 중요하다.
```

#### 8.1.1 통합 테스트의 역할

```markdown
단위 테스트는 다음 세 가지 요구 사항을 충족하는 테스트다.
- 단일 동작 단위를 검증하고,
- 빠르게 수행하고,
- 다른 테스트와 별도로 처리한다.
이 세 가지 요구 사항 중 하나라도 충족하지 못하는 테스트는 통합 테스트 범주에 속한다.
단위 테스트가 아닌 모든 테스트가 통합 테스트에 해당한다.
실제로 통합 테스트는 대부분 시스템이 프로세스 외부 의존성과 통합해 어떻게 작동하는지를 검증한다.
...
단위 테스트는 도메인 모델을 다루는 반면, 통합 테스트는 프로세스 외부 의존성과 도메인 모델을 연결하는 코드를 확인한다.
...
단위 테스트로 가능한 한 많이 비즈니스 시나리오의 예외 상황을 확인하고, 통합 테스트는 주요 흐름(happy path)과 단위 테스트가 다루지 못하는 기타 예외 상황(edge case)을 다룬다.
...
통합 테스트는 단순한 애플리케이션에서도 가치가 있다.
코드가 얼마나 간단한지보다 다른 서브 시스템과 통합해 어떻게 작동하는지 확인하는 것이 더 중요하다.
```

### 8.2 어떤 프로세스 외부 의존성을 직접 테스트해야 하는가?

```markdown
앞서 언급했듯이 통합 테스트는 시스템이 프로세스 외부 의존성과 어떻게 통합하는지를 검증한다.
이러한 검증을 구현하는 방식은 두 가지가 있다.
실제 프로세스 외부 의존성을 사용하거나 해당 의존성을 목으로 대체하는 것이다.
```

#### 8.2.1 프로세스 외부 의존성의 두 가지 유형

```markdown
모든 프로세스 외부 의존성은 두 가지 범주로 나뉜다.
- 관리 의존성(전체를 제어할 수 있는 프로세스 외부 의존성): 이러한 의존성은 애플리케이션을 통해서만 접근할 수 있으며,
  해당 의존성과의 상호 작용은 외부 환경에서 볼 수 없다.   
  대표적인 예로 데이터베이스가 있다.
  외부 시스템은 보통 데이터베이스에 직접 접근하지 않고 애플리케이션에서 제공하는 API를 통해 접근한다.
- 비관리 의존성(전체를 제어할 수 없는 프로세스 외부 의존성): 해당 의존성과의 상호 작용을 외부에서 볼 수 있다.
  예를 들어 SMTP 서버와 메시지 버스 등이 있다.
  둘 다 다른 애플리케이션에서 볼 수 있는 사이드 이펙트를 발생시킨다.
...
관리 의존성은 실제 인스턴스를 사용하고, 비관리 의존성은 목으로 대체하라.
```

#### 8.2.2 관리 의존성이면서 비관리 의존성인 프로세스 외부 의존성 다루기

```markdown
때로는 관리 의존성과 비관리 의존성 모두의 속성을 나타내는 프로세스 외부 의존성이 있을 수 있다.
좋은 예로, 다른 애플리케이션이 접근할 수 있는 데이터베이스가 있다.
...
결과적으로 데이터베이스는 관리 의존성이면서 비관리 의존성이다.
...
이 경우 다른 애플리케이션에서 볼 수 있는 테이블을 비관리 의존성으로 취급하라.
...
그리고 나머지 데이터베이스를 관리 의존성으로 처리하고, 데이터베이스와의 상호 작용을 검증하지 말고 데이터베이스의 최종 상태를 확인하라.
```

#### 8.4.2 프로세스 외부 의존성에 인터페이스를 사용하는 이유는 무엇인가?

```markdown
그렇다면 각 인터페이스에 구현이 하나만 있다고 가정할 때 프로세스 외부 의존성에 인터페이스를 사용하는 이유는 무엇인가?
진짜 이유는 훨씬 더 실용적이고 현실적이다.
간단히 말하자면, 목을 사용하기 위함이다.
인터페이스가 없으면 테스트 대역을 만들 수 없으므로 테스트 대상 시스템과 프로세스 외부 의존성 간의 상호작용을 확인할 수 없다.
따라서 이러한 의존성을 목으로 처리할 필요가 없는 한, 프로세스 외부 의존성에 대한 인터페이스를 두지 말라.
비관리 의존성만 목으로 처리하므로, 결국 비관리 의존성에 대해서만 인터페이스를 쓰라는 지침이 된다.
관리 의존성을 컨트롤러에 명시적으로 주입하고, 해당 의존성을 구체 클래스로 사용하라.
```

### 8.5 통합 테스트 모범 사례

```markdown
통합 테스트를 최대한 활용하는 데 도움이 되는 몇 가지 일반적인 지침이 있다.
- 도메인 모델 경계 명시하기
- 애플리케이션 내 계층 줄이기
- 순환 의존성 제거하기
```

#### 8.5.1 도메인 모델 경계 명시하기

```markdown
항상 도메인 모델을 코드베이스에서 명시적이고 잘 알려진 위치에 두도록 하라.
도메인 모델은 프로젝트가 해결하고자 하는 문제에 대한 도메인 지식의 모음이다.
도메인 모델에 명시적 경계를 지정하면 코드의 해당 부분을 더 잘 보여주고 더 잘 설명할 수 있다.
이렇게 하면 테스트에도 도움이 된다.
단위 테스트는 도메인 모델과 알고리즘을 대상으로 하고, 통합 테스트는 컨트롤러를 대상으로 한다.
```

#### 8.5.2 계층 수 줄이기

```markdown
극단적인 경우로, 애플리케이션에 추상 계층이 너무 많으면 코드베이스를 탐색하기 어렵고 아주 간단한 연산이라 해도 숨은 로직을 이해하기가 너무 어려워진다.
...
추상화가 지나치게 많으면 단위 테스트와 통합 테스트에도 도움이 되지 않는다.
간접 계층이 많은 코드베이스는 컨트롤러와 도메인 모델 사이에 명확한 경계가 없는 편이다.
```
